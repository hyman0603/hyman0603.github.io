---
layout: post
title: "Cå†…å­˜åˆ†é…ä¸å¤„ç†"
category: "c/c++"
---

å”‰å“Ÿæˆ‘å»ï¼Œèµµå²©çš„ã€ŠCè¯­è¨€ç‚¹æ»´ã€‹é”™è¯¯å¤ªå¤šäº†ï¼Œä¸å ªå…¥ç›®ğŸ™ˆå•Šã€‚

# ä¸€. C æ•°æ®ç±»å‹ä¸€è§ˆ

![](http://beginman.qiniudn.com/2016-12-10-14813512775739.jpg)

# äºŒ. C å†…å­˜æ˜ è±¡

![](http://beginman.qiniudn.com/2016-12-10-14813516235205.jpg)


| åŒº | å­˜å‚¨ |
| --- | --- |
| æ ˆåŒº | å±€éƒ¨å˜é‡ï¼Œè¿”å›å€¼,å½¢å‚ç­‰(çŸ­ç”Ÿå‘½å‘¨æœŸ),è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾ï¼Œå¿«å¦‚é—ªç”µï¼Œä½†å®¹é‡å°. |
| å †åŒº | åŠ¨æ€(malloc/free),è‡ªå·±ç®¡ç†å†…å­˜ |
| é™æ€åŒº | å…¨å±€å˜é‡ï¼Œstatic |
| å¸¸é‡åŒº | å¸¸é‡(ä¸å¯å˜) |
| ä»£ç åŒº | ç¨‹åº |

>â€œæ ˆå’Œå †æ˜¯å¯¹å‘å¢é•¿çš„ï¼Œå®ƒä»¬çš„å®¹é‡å¹¶ä¸æ˜¯æ— é™çš„ï¼Œè€Œæ˜¯ä¸€å®šçš„ã€‚å½“ä½¿ç”¨é€’å½’å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœè°ƒç”¨çš„å±‚æ•°å¤ªæ·±ï¼Œæ ˆä¼šä¸æ–­åœ°å¢é•¿ï¼Œæœ€åå°±ä¼šé€ æˆæ ˆæº¢å‡ºï¼ˆstack overflowï¼‰çš„é”™è¯¯ã€‚â€


```c
// æœ€ç®€å•çš„é€’å½’å‡½æ•°
// è¿™æ®µç¨‹åºè¿è¡Œä¸åˆ°ä¸€åˆ†é’Ÿå°±äº§ç”Ÿ"æ ˆæº¢å‡º"å¼‚å¸¸è€Œç»ˆæ­¢
void main()
{
    main();
}
```

ç¨‹åºä¸­ï¼Œå˜é‡ä½ç½®çš„ä¸åŒå†³å®šäº†å…¶åœ¨å†…å­˜ä¸­çš„æ˜ è±¡ï¼š

```c
int a = 4;              // å…¨å±€å˜é‡, ä¿å­˜åœ¨é™æ€å­˜å‚¨å™¨
static float f = 2.0f;  // é™æ€å˜é‡, ä¿å­˜åœ¨é™æ€å­˜å‚¨å™¨

int foo(int i)
{
    i++;        // å‡½æ•°å®å‚i, ä¿å­˜åœ¨æ ˆä¸Š
    return i;
}

int main(int argc, char **argv)
{
    int *p, k = 5;              // å±€éƒ¨å˜é‡ p,kä¿å­˜åœ¨æ ˆä¸Š
    char *pstr = "hello";       // helloå­—ç¬¦ä¸²ä¿å­˜åœ¨å¸¸é‡å­˜å‚¨åŒº, psträ¿å­˜æ ˆä¸Š
    char astr[10] = "hello";    // helloå­—ç¬¦ä¸²ä»¥åŠå˜é‡astréƒ½ä¿å­˜åœ¨æ ˆä¸Š

    char *l = (char*)malloc(1); // å˜é‡p,ä¿å­˜åœ¨æ ˆä¸Š, p æŒ‡å‘çš„å†…å­˜åœ¨å †ä¸Š
    free(l);                    // é‡Šæ”¾åœ¨å †ä¸Šç”³è¯·çš„å†…å­˜

    int m = foo(k);
    printf("m=%d\n", m);
}
```

# ä¸‰.å†…å­˜åˆ†é…ä¸é‡Šæ”¾

å†…å­˜åˆ†é…å‡½æ•°ï¼š`malloc`å’Œ`calloc`, loc è¯»`[loÊŠk]`, å†…å­˜é‡Šæ”¾`free`ã€‚

æ³¨æ„**åˆ†é…çš„æ—¶å€™éƒ½æ²¡æœ‰æ•°æ®ç±»å‹çš„æ¦‚å¿µï¼Œåˆ†é…çš„åŸºæœ¬å•ä½å°±æ˜¯å­—èŠ‚**ã€‚å¦‚æœä½ æƒ³åˆ†é…10 ä¸ªint ç±»å‹çš„æ•°ï¼Œä¸èƒ½å†™æˆmalloc(10)ï¼Œè€Œåº”è¯¥å†™æˆ `malloc(sizeof(int) * 10)`

åˆ†åˆ«å£°æ˜å¦‚ä¸‹ï¼š

```c
// size ä¸ºéœ€è¦åˆ†é…çš„å†…å­˜ç©ºé—´çš„å¤§å°ï¼Œä»¥å­—èŠ‚ï¼ˆByteï¼‰è®¡, å¹¶è¿”å›è¯¥ç©ºé—´çš„é¦–åœ°å€
void	*malloc(size_t size);      

// ä»å †ä¸Šè·å¾—size * nçš„å­—èŠ‚ç©ºé—´ï¼Œå¹¶è¿”å›è¯¥ç©ºé—´çš„é¦–åœ°å€
void	*calloc(size_t n, size_t size);

// é‡æ–°åˆ†é…
void * realloc(void * p,int n);

// ç”±äºå½¢å‚ä¸ºvoidæŒ‡é’ˆï¼Œfreeå‡½æ•°å¯ä»¥æ¥å—ä»»æ„ç±»å‹çš„æŒ‡é’ˆå®å‚ã€‚
void	 free(void *);     
```

## 3.1 malloc and calloc and realloc

åˆ†é…æˆåŠŸè¿”å›æŒ‡å‘è¯¥å†…å­˜çš„åœ°å€ï¼Œå¤±è´¥åˆ™è¿”å› NULLã€‚

æ³¨æ„ï¼šå‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯ `void *`ï¼Œ**void ç±»å‹æ˜æ˜¾æœ‰æ³›å‹çš„æ¦‚å¿µï¼Œç”¨æˆ·éœ€è¦æŠŠvoid ç±»å‹å¼ºåˆ¶è½¬æ¢æˆéœ€è¦çš„ç±»å‹**, void å¹¶ä¸æ˜¯è¯´æ²¡æœ‰è¿”å›å€¼æˆ–è€…è¿”å›ç©ºæŒ‡é’ˆï¼Œè€Œæ˜¯è¿”å›çš„æŒ‡é’ˆç±»å‹æœªçŸ¥ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ malloc() æ—¶é€šå¸¸éœ€è¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå°† void æŒ‡é’ˆè½¬æ¢æˆæˆ‘ä»¬å¸Œæœ›çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼š

```c
char *ptr = (char *)malloc(10);  // åˆ†é…10ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾å­—ç¬¦
```

**mallocä¸callocçš„ä¸åŒï¼š**

- mallocå‡½æ•°åˆ†é…å¾—åˆ°çš„å†…å­˜ç©ºé—´æ˜¯æœªåˆå§‹åŒ–çš„
- **å‡½æ•°calloc ä¼šå°†æ‰€åˆ†é…çš„å†…å­˜ç©ºé—´ä¸­çš„æ¯ä¸€ä½éƒ½åˆå§‹åŒ–ä¸ºé›¶**ã€‚ä¸ºå­—ç¬¦ç±»å‹æˆ–æ•´æ•°ç±»å‹çš„å…ƒç´ åˆ†é…å†…å­˜ï¼Œé‚£ä¹ˆè¿™äº›å…ƒç´ å°†ä¿è¯ä¼šè¢«åˆå§‹åŒ–ä¸º0ï¼›æŒ‡é’ˆç±»å‹çš„å…ƒç´ åˆ†é…å†…å­˜åˆå§‹åŒ–ä¸ºç©ºæŒ‡é’ˆNULLï¼›å®å‹æ•°æ®åˆ†é…å†…å­˜ï¼Œåˆå§‹åŒ–ä¸ºæµ®ç‚¹å‹çš„é›¶â€
- mallocå¯ä»¥é…åˆmemsetæ¨¡æ‹Ÿcalloc
- mallocé€Ÿåº¦å¿«ã€‚
- å¦‚æœåˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ï¼Œæ¨èç”¨callocï¼Œ å¿«ä¸€äº›ã€‚

å¦‚ä¸‹å®ä¾‹ï¼š

```c
size_t size = sizeof(int);
int count = 1;

int *pm = (int *)malloc(count * size);
if (pm == NULL) exit(1);
printf("*pm=%d\n", *pm);

memset(pm, 0, count * size);    // å°†pmæŒ‡å‘çš„ç©ºé—´æ¸…0
printf("*pm=%d\n", *pm);

int *pc = calloc(count, size);
printf("*pc=%d\n", *pc);

free(pm);
free(pc);
pm = NULL;
pc = NULL;
```

**reallocå‡½æ•°**

    void * realloc(void * p,int n);

>å…¶ä¸­ï¼ŒæŒ‡é’ˆpå¿…é¡»ä¸ºæŒ‡å‘å †å†…å­˜ç©ºé—´çš„æŒ‡é’ˆï¼Œå³ç”±mallocå‡½æ•°ã€callocå‡½æ•°æˆ–reallocå‡½æ•°åˆ†é…ç©ºé—´çš„æŒ‡é’ˆã€‚reallocå‡½æ•°å°†æŒ‡é’ˆpæŒ‡å‘çš„å†…å­˜å—çš„å¤§å°æ”¹å˜ä¸ºnå­—èŠ‚ã€‚å¦‚æœnå°äºæˆ–ç­‰äºpä¹‹å‰æŒ‡å‘çš„ç©ºé—´å¤§å°ï¼Œé‚£ä¹ˆã€‚ä¿æŒåŸæœ‰çŠ¶æ€ä¸å˜ã€‚å¦‚æœnå¤§äºåŸæ¥pä¹‹å‰æŒ‡å‘çš„ç©ºé—´å¤§å°ï¼Œé‚£ä¹ˆï¼Œç³»ç»Ÿå°†é‡æ–°ä¸ºpä»å †ä¸Šåˆ†é…ä¸€å—å¤§å°ä¸ºnçš„å†…å­˜ç©ºé—´ï¼ŒåŒæ—¶ï¼Œå°†åŸæ¥æŒ‡å‘ç©ºé—´çš„å†…å®¹ä¾æ¬¡å¤åˆ¶åˆ°æ–°çš„å†…å­˜ç©ºé—´ä¸Šï¼Œpä¹‹å‰æŒ‡å‘çš„ç©ºé—´è¢«é‡Šæ”¾ã€‚rellocå‡½æ•°åˆ†é…çš„ç©ºé—´ä¹Ÿæ˜¯æœªåˆå§‹åŒ–çš„ã€‚


## 3.2 free

**freeå‡½æ•°åªæ˜¯é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œè€Œè¯¥æŒ‡é’ˆä»ç„¶æŒ‡å‘åŸæ¥æŒ‡å‘çš„åœ°æ–¹ï¼Œæ­¤æ—¶ï¼ŒæŒ‡é’ˆä¸º`é‡æŒ‡é’ˆ`ï¼Œå¦‚æœæ­¤æ—¶æ“ä½œè¯¥æŒ‡é’ˆä¼šå¯¼è‡´ä¸å¯é¢„æœŸçš„é”™è¯¯ã€‚å®‰å…¨åšæ³•æ˜¯ï¼šåœ¨ä½¿ç”¨freeå‡½æ•°é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„ç©ºé—´ä¹‹åï¼Œå°†æŒ‡é’ˆçš„å€¼ç½®ä¸ºNULL**

```c
free(p);
p = NULL;
```

# å°å®éªŒ

æ¥æŒ‡å‡ºå“ªäº›åœ°æ–¹ä¼šå‡ºé”™ï¼š

```c
char *gp = "hello";     
char ga[] = "hello";   

char *f() {
    char *p = "hello"; 
    char a[] = "hello";
    p[0] = 'A';     // ?
    gp[0] = 'B';    // ?
    gp = a;         
    gp[0] = 'C';    // ?
    printf("gp=%s\n", gp);  // è¯·é—®è¿™é‡Œè¾“å‡ºä»€ä¹ˆï¼Ÿ
    return a;       // ?
}

int main(int argc, char **argv)
{
    char *str = f();
    str[0] = 'D';   // ?
    ga[0] = 'E';    // ?
    // è¯·é—®è¾“å‡ºä»€ä¹ˆï¼Ÿ
    printf("gp=%s, str=%s, ga=%s\n", gp, str, ga);
    return 0;
}
```

å‡å¦‚è¿™æ˜¯ä¸€é“é¢è¯•é¢˜ï¼Œé‚£ä¹ˆè€ƒçš„å°±æ˜¯**å†…å­˜æ˜ è±¡ï¼Œææ˜ç™½å®ƒä»¬çš„å­˜å‚¨ä½ç½®å°±èƒ½è§£å‡ºè¿™é“é¢˜ã€‚** 

é¦–å…ˆåˆ†æä¸‹ç¨‹åºï¼Œè¯•å›¾æ”¹å˜ä¿å­˜åœ¨å¸¸é‡å­˜å‚¨åŒºå­—ç¬¦ä¸²çš„æ“ä½œéƒ½æ˜¯ä¸åˆæ³•çš„ï¼Œå› ä¸ºgp å’Œp æŒ‡å‘çš„â€œhelloâ€å’Œâ€œhelloâ€ä¿å­˜åœ¨å¸¸é‡å­˜å‚¨åŒº

å…¶æ¬¡ï¼Œæ•°ç»„ga å’Œa çš„å†…å®¹ï¼Œæˆ–è€…ä¿å­˜åœ¨é™æ€å­˜å‚¨åŒºï¼Œæˆ–è€…ä¿å­˜åœ¨æ ˆä¸Šï¼Œå®ƒä»¬éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæœ‰è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å…è®¸å¯¹æ•°ç»„çš„å†…å®¹è¿›è¡Œä¿®æ”¹ã€‚ä½†æ˜¯ï¼Œæ•°ç»„`char a[]`åœ¨æ ˆä¸Šç”Ÿæˆï¼Œå½“å‡½æ•°f ç»“æŸçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å±€éƒ¨å˜é‡éƒ½ä»æ ˆä¸­å¼¹å‡ºè€Œæ¶ˆå¤±ï¼Œæ‰€ä»¥æ•°ç»„`char a[]`å’Œå…¶å†…å®¹éƒ½ä¸å†å­˜åœ¨ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå³ä½¿ç”¨str å¾—åˆ°äº†æ•°ç»„çš„åœ°å€ï¼Œä¹Ÿæ˜¯æŒ‡å‘ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°ç»„ã€‚æ‰€ä»¥str[0]='D';ä¹Ÿæ˜¯ä¸å…è®¸çš„ã€‚

æœ€åã€‚æŒ‡é’ˆgp å’Œp æ‰€æŒ‡å‘çš„å†…å®¹ä¸å¯ä¿®æ”¹ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€æŒ‡é’ˆæœ¬èº«çš„å€¼ã€ä¹Ÿå°±æ˜¯æŒ‡é’ˆçš„æŒ‡å‘ä¸å¯ä¿®æ”¹ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥å†™å‡ºgp=a çš„è¯­å¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œgp æŒ‡å‘æ•°ç»„aï¼Œè¿™æ ·ï¼Œgp[0]='C'å°±æ˜¯åˆæ³•çš„äº†ã€‚çœ‹æ¥ï¼ŒæŒ‡é’ˆåªæ˜¯æŒ‡å‘ä¸€ä¸ªå­˜å‚¨åœ°ç‚¹ï¼Œä¸åŒçš„å­˜å‚¨åœ°ç‚¹æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œæ‰€ä»¥ï¼ŒæŒ‡é’ˆä¹Ÿå°±æœ‰äº†å¯¹åº”çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§å¹¶ä¸æ˜¯æŒ‡é’ˆå¸¦æ¥çš„ï¼Œè€Œæ˜¯ç”±å­—ç¬¦ä¸²å¤„åœ¨ä¸åŒçš„å­˜å‚¨åœ°ç‚¹å¸¦æ¥çš„ã€‚

çœ‹ä¸‹é¢æ³¨é‡Šè¿‡çš„ç¨‹åºï¼š

```c
char *gp = "hello";     // å­—ç¬¦ä¸²hello ä¿å­˜åœ¨å¸¸é‡å­˜å‚¨åŒº, è€ŒæŒ‡é’ˆgpä¿å­˜åœ¨é™æ€å­˜å‚¨åŒº
char ga[] = "hello";   // helloå’Œæ•°ç»„gaä¿å­˜åœ¨é™æ€å­˜å‚¨åŒº

char *f() {
    char *p = "hello"; // helloä¿å­˜åœ¨å¸¸é‡å­˜å‚¨å™¨, æŒ‡é’ˆpä¿å­˜åœ¨æ ˆä¸Š
    char a[] = "hello";// helloå’Œæ•°ç»„a ä¿å­˜åœ¨æ ˆä¸Š
//    p[0] = 'A';   // runtime error -> bus error
//    gp[0] = 'B';  // runtime error -> bus error
    gp = a;
    gp[0] = 'C';    // OK
    printf("gp=%s\n", gp);
    return p;       // æŠŠ a æ”¹æˆ pï¼Œ return p;
}

int main(int argc, char **argv)
{
    char *str = f();
//    str[0] = 'D'; // runtime error -> bus error
    ga[0] = 'E';    // ok
    printf("gp=%s, str=%s, ga=%s\n", gp, str, ga);
    return 0;
}
```

è¾“å‡ºå¦‚ä¸‹ï¼š
    
    gp=Cello
    gp=, str=hello, ga=Eello

ä¸ªä¸­åŸå› å°±ä¸è¯´äº†ï¼Œè§ä¸Šé¢ã€‚

# å‚è€ƒ

- [ã€ŠCè¯­è¨€ç‚¹æ»´ã€‹]
- [Cä¸­å †ç®¡ç†â€”â€”æµ…è°ˆmalloc,calloc,reallocå‡½æ•°ä¹‹é—´çš„åŒºåˆ«](http://www.cppblog.com/sandywin/archive/2011/09/14/155746.html)



