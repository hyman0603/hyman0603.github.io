{% if theme.calendar.enable %}
{% if page.type == 'schedule' %}
// Initialization
var _n = function(arg) { if(arg) return arg; else return void 0;}
var cal_data = void 0;
var now = new Date();
var timeMax = new Date();
var timeMin = new Date();
// Read config form theme config file
var calId           = _n('{{ theme.calendar.calendar_id  }}')                ;
var apiKey          = _n('{{ theme.calendar.api_key      }}')                ;
timeMax.setHours(now.getHours() + offsetMax);
timeMin.setHours(now.getHours() - offsetMin);
// Build URL
BASE_URL            = 'https://www.googleapis.com/calendar/v3/calendars/';
FIELD_KEY           = 'key';
FIELD_ORDERBY       = 'orderBy';
FIELD_TIMEMAX       = 'timeMax';
FIELD_TIMEMIN       = 'timeMin';
FIELD_TIMEZONE      = 'timeZone';
FIELD_SHOWDELETED   = 'showDeleted';
FIELD_SINGLEEVENTS  = 'singleEvents';
FIELD_MAXRESULTS    = 'maxResults';
timeMaxISO          = timeMax.toISOString();
timeMinISO          = timeMin.toISOString();
request_url = BASE_URL + calId + '/events?'  +
  FIELD_MAXRESULTS    + '=' + maxResults;
if (timeZone) {
}
fetchData();
var queryLoop = setInterval(fetchData, 60000);
function fetchData() {
  $.ajax({
    dataType: 'json',
    url: request_url,
    success: function(data) {
      $eventList = $('#schedule #event-list');
      // clean the event list
      $eventList.html("");
      data['items'].forEach((event) =
        // parse data
        var start = new Date(event.start.dateTime);
        var end   = new Date(event.end.dateTime);
        tense = judgeTense(now, start, end); // 0:now 1:future -1:past
        eventDOM = buildEventDOM(tense, event);
        $eventList.append(eventDOM);
        prevEnd = end;
      });
    }
  });
}
function getRelativeTime(current, previous) {
  var msPerMinute = 60 * 1000;
  var msPerHour = msPerMinute * 60;
  var msPerDay = msPerHour * 24;
  var msPerMonth = msPerDay * 30;
  var msPerYear = msPerDay * 365;
  var elapsed = current - previous;
  var tense = elapsed  ? "ago" : "later";
  elapsed = Math.abs(elapsed);
  if      ( elapsed   ) {
    return Math.round(elapsed/msPerMinute) + ' minutes ' + tense;
  }
  else if ( elapsed    ) {
    return Math.round(elapsed/msPerHour) + ' hours ' + tense;
  }
  else if ( elapsed  ) {
    return 'about ' + Math.round(elapsed/msPerDay) + ' days ' + tense;
  }
  else if ( elapsed   ) {
    return 'about ' + Math.round(elapsed/msPerMonth) + ' months ' + tense;
  }
  else {
    return 'about' + Math.round(elapsed/msPerYear) + ' years' + tense;
  }
}
function judgeTense(now, eventStart, eventEnd) {
  if      (eventEnd     { return -1; }
  else if (eventStart   { return  1; }
  else                        { return  0; }
}
function buildEventDOM(tense, event) {
  var tenseClass = "";
  var start      = new Date(event.start.dateTime);
  var end        = new Date(event.end.dateTime);
  switch(tense) {
    case 0 : // now
      tenseClass = "event-now";
      break;
    case 1 : // future
      tenseClass = "event-future";
      break;
    case -1: // past
      tenseClass = "event-past";
      break;
    default:
      throw "Time data error";
  }
  durationFormat = {
    weekday: 'short',
    hour: '2-digit',
    minute:'2-digit'
  };
  relativeTimeStr = (tense == 0) ? "NOW" : getRelativeTime(now, start);
  durationStr = start.toLocaleTimeString([], durationFormat) + " - " +
                end.toLocaleTimeString([], durationFormat);
  liOpen                = ` class="event ${tenseClass}"
  liClose               = `
  h2Open                = ` class="event-summary"
  h2Close               = `
  locationDOM     = "";
                      ${event['location']}
                     
  }
                      ${relativeTimeStr}
                     
                      ${durationStr}
                     
  eventContent =
    liOpen +
      h2Open +
        event['summary'] +
        relativeTimeDOM+
      h2Close +
      locationDOM +
      durationDOM +
    liClose;
  return eventContent;
}
{% endif %}
{% endif %}
