<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.ywthings.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前期准备环境 Ceph版本：v14 (nautilus)  k8s:1.17.x  Cenos 7.6">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Ceph RBD持久化存储部署K8S EFK">
<meta property="og:url" content="https://www.ywthings.com/posts/cb5eee23.html">
<meta property="og:site_name" content="hyman">
<meta property="og:description" content="前期准备环境 Ceph版本：v14 (nautilus)  k8s:1.17.x  Cenos 7.6">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-25T07:59:42.000Z">
<meta property="article:modified_time" content="2020-05-17T23:58:41.035Z">
<meta property="article:author" content="hyman">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="kubernets">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.ywthings.com/posts/cb5eee23.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>使用Ceph RBD持久化存储部署K8S EFK | hyman</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hyman</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一些简单的记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.ywthings.com/posts/cb5eee23.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hyman">
      <meta itemprop="description" content="一些简单的记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hyman">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用Ceph RBD持久化存储部署K8S EFK
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-25 15:59:42" itemprop="dateCreated datePublished" datetime="2020-03-25T15:59:42+08:00">2020-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-18 07:58:41" itemprop="dateModified" datetime="2020-05-18T07:58:41+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li><p>Ceph版本：v14 (nautilus)</p>
</li>
<li><p>k8s:1.17.x</p>
</li>
<li><p>Cenos 7.6</p>
<span id="more"></span>
<h1 id="Ceph"><a href="#Ceph" class="headerlink" title="Ceph"></a>Ceph</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#创建存储池</span><br><span class="line"># ceph osd pool create k8s 128 128</span><br><span class="line">#查看存储池</span><br><span class="line"># ceph osd pool ls</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Ceph-创建账号"><a href="#Ceph-创建账号" class="headerlink" title="Ceph 创建账号"></a>Ceph 创建账号</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">可以直接使用Ceph的admin账号，当然生产环境中还是要根据不同功能客户端分配不同的账号：</span><br><span class="line">ceph auth get-or-create client.k8s mon &#x27;allow r&#x27; osd &#x27;allow rwx pool=k8s&#x27; -o ceph.client.k8s.keyring</span><br><span class="line"></span><br><span class="line">获取账号的密钥：</span><br><span class="line">ceph auth get-key client.admin | base64</span><br></pre></td></tr></table></figure>

<h1 id="K8S-使用-Ceph-RBD存储"><a href="#K8S-使用-Ceph-RBD存储" class="headerlink" title="K8S 使用 Ceph RBD存储"></a>K8S 使用 Ceph RBD存储</h1><h2 id="创建-namespace"><a href="#创建-namespace" class="headerlink" title="创建 namespace"></a>创建 namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  namespace.yaml  &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: efk</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f namespace.yaml</span><br></pre></td></tr></table></figure>

<h2 id="为存储类提供secret"><a href="#为存储类提供secret" class="headerlink" title="为存储类提供secret"></a>为存储类提供secret</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ceph-efk-secret.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph-admin-secret</span><br><span class="line">  namespace: efk </span><br><span class="line">data:</span><br><span class="line">  key: QVFBRkwyOWU4WUQ3SlJBQVhtajVVRnJ0TUZVVnZaanVMYkRuT3c9PQ==</span><br><span class="line">type: kubernetes.io/rbd</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph-efk-secret</span><br><span class="line">  namespace: efk </span><br><span class="line">data:</span><br><span class="line">  key: QVFBRkwyOWU4WUQ3SlJBQVhtajVVRnJ0TUZVVnZaanVMYkRuT3c9PQ==</span><br><span class="line">type: kubernetes.io/rbd</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f ceph-efk-secret.yaml</span><br></pre></td></tr></table></figure>


<h2 id="创建动态RBD-StorageClass"><a href="#创建动态RBD-StorageClass" class="headerlink" title="创建动态RBD StorageClass"></a>创建动态RBD StorageClass</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ceph-efk-storageclass.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph-efk</span><br><span class="line">  namespace: efk</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: &quot;false&quot;</span><br><span class="line">provisioner: ceph.com/rbd</span><br><span class="line">reclaimPolicy: Retain</span><br><span class="line">parameters:</span><br><span class="line">  monitors: 192.168.1.65:6789,192.168.1.66:6789,192.168.1.67:6789</span><br><span class="line">  adminId: admin</span><br><span class="line">  adminSecretName: ceph-admin-secret</span><br><span class="line">  adminSecretNamespace: efk</span><br><span class="line">  pool: k8s</span><br><span class="line">  fsType: ext4</span><br><span class="line">  userId: admin</span><br><span class="line">  userSecretName: ceph-efk-secret</span><br><span class="line">  imageFormat: &quot;2&quot;</span><br><span class="line">  imageFeatures: &quot;layering&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f ceph-efk-storageclass.yaml</span><br></pre></td></tr></table></figure>

<h2 id="为controller-manager提供rbd命令"><a href="#为controller-manager提供rbd命令" class="headerlink" title="为controller-manager提供rbd命令"></a>为controller-manager提供rbd命令</h2><p>使用StorageClass动态创建PV时，controller-manager会自动在Ceph上创建image，所以我们要为其准备好rbd命令。<br>如果集群是用kubeadm部署的，由于controller-manager官方镜像中没有rbd命令，所以我们要导入外部配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; rbd-provisioner.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRole </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1 </span><br><span class="line">metadata: </span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: efk </span><br><span class="line">rules: </span><br><span class="line">  - apiGroups: [&quot;&quot;] </span><br><span class="line">    resources: [&quot;persistentvolumes&quot;] </span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;] </span><br><span class="line">  - apiGroups: [&quot;&quot;] </span><br><span class="line">    resources: [&quot;persistentvolumeclaims&quot;] </span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;] </span><br><span class="line">  - apiGroups: [&quot;storage.k8s.io&quot;] </span><br><span class="line">    resources: [&quot;storageclasses&quot;] </span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] </span><br><span class="line">  - apiGroups: [&quot;&quot;] </span><br><span class="line">    resources: [&quot;events&quot;] </span><br><span class="line">    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] </span><br><span class="line">  - apiGroups: [&quot;&quot;] </span><br><span class="line">    resources: [&quot;services&quot;] </span><br><span class="line">    resourceNames: [&quot;kube-dns&quot;,&quot;coredns&quot;] </span><br><span class="line">    verbs: [&quot;list&quot;, &quot;get&quot;] </span><br><span class="line">--- </span><br><span class="line">kind: ClusterRoleBinding </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1 </span><br><span class="line">metadata: </span><br><span class="line">  name: rbd-provisioner </span><br><span class="line">  namespace: efk</span><br><span class="line">subjects: </span><br><span class="line">  - kind: ServiceAccount </span><br><span class="line">    name: rbd-provisioner </span><br><span class="line">    namespace: default </span><br><span class="line">roleRef: </span><br><span class="line">  kind: ClusterRole </span><br><span class="line">  name: rbd-provisioner </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io </span><br><span class="line">--- </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1 </span><br><span class="line">kind: Role </span><br><span class="line">metadata: </span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: efk </span><br><span class="line">rules: </span><br><span class="line">- apiGroups: [&quot;&quot;] </span><br><span class="line">  resources: [&quot;secrets&quot;] </span><br><span class="line">  verbs: [&quot;get&quot;] </span><br><span class="line">- apiGroups: [&quot;&quot;] </span><br><span class="line">  resources: [&quot;endpoints&quot;] </span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] </span><br><span class="line">--- </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1 </span><br><span class="line">kind: RoleBinding </span><br><span class="line">metadata: </span><br><span class="line">  name: rbd-provisioner </span><br><span class="line">  namespace: efk</span><br><span class="line">roleRef: </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io </span><br><span class="line">  kind: Role </span><br><span class="line">  name: rbd-provisioner </span><br><span class="line">subjects: </span><br><span class="line">  - kind: ServiceAccount </span><br><span class="line">    name: rbd-provisioner </span><br><span class="line">    namespace: default </span><br><span class="line">--- </span><br><span class="line">apiVersion: extensions/v1beta1 </span><br><span class="line">kind: Deployment </span><br><span class="line">metadata: </span><br><span class="line">  name: rbd-provisioner </span><br><span class="line">  namespace: efk</span><br><span class="line">spec: </span><br><span class="line">  replicas: 1 </span><br><span class="line">  strategy: </span><br><span class="line">    type: Recreate </span><br><span class="line">  template: </span><br><span class="line">    metadata: </span><br><span class="line">      labels: </span><br><span class="line">        app: rbd-provisioner </span><br><span class="line">    spec: </span><br><span class="line">      containers: </span><br><span class="line">      - name: rbd-provisioner </span><br><span class="line">        image: quay.io/external_storage/rbd-provisioner:latest </span><br><span class="line">        env: </span><br><span class="line">        - name: PROVISIONER_NAME </span><br><span class="line">          value: ceph.com/rbd </span><br><span class="line">      serviceAccount: rbd-provisioner </span><br><span class="line">--- </span><br><span class="line">apiVersion: v1 </span><br><span class="line">kind: ServiceAccount </span><br><span class="line">metadata: </span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: efk</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f rbd-provisioner.yaml</span><br></pre></td></tr></table></figure>

<h2 id="为kubelet提供rbd命令"><a href="#为kubelet提供rbd命令" class="headerlink" title="为kubelet提供rbd命令"></a>为kubelet提供rbd命令</h2><p>创建pod时，kubelet需要使用rbd命令去检测和挂载pv对应的ceph image，所以要在所有的worker节点安装ceph客户端ceph-common-14.2.8。<br>并且需要复制ceph.client.admin.keyring、ceph.conf文件到/etc/ceph目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install ceph-common -y</span><br><span class="line"></span><br><span class="line">yum install epel-release -y </span><br></pre></td></tr></table></figure>

<p>无安装epel-release否则会提示一下错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">---&gt; Package python-backports.x86_64 0:1.0-8.el7 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line">Error: Package: 2:librgw2-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 2:ceph-common-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: libleveldb.so.1()(64bit)</span><br><span class="line">Error: Package: 2:ceph-common-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: libbabeltrace.so.1()(64bit)</span><br><span class="line">Error: Package: 2:ceph-common-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liboath.so.0(LIBOATH_1.2.0)(64bit)</span><br><span class="line">Error: Package: 2:ceph-common-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: libbabeltrace-ctf.so.1()(64bit)</span><br><span class="line">Error: Package: 2:librados2-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 2:librbd1-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 2:ceph-common-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liboath.so.0()(64bit)</span><br><span class="line">Error: Package: 2:ceph-common-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liboath.so.0(LIBOATH_1.10.0)(64bit)</span><br><span class="line">Error: Package: 2:librgw2-14.2.8-0.el7.x86_64 (Ceph)</span><br><span class="line">           Requires: liboath.so.0()(64bit)</span><br><span class="line"> You could try using --skip-broken to work around the problem</span><br><span class="line"> You could try running: rpm -Va --nofiles --nodigest</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="创建Elasticsearch"><a href="#创建Elasticsearch" class="headerlink" title="创建Elasticsearch"></a>创建Elasticsearch</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; elasticsearch.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: efk</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/name: &quot;Elasticsearch&quot;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9200</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: db</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">---</span><br><span class="line"># RBAC authn and authz</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: efk</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - &quot;services&quot;</span><br><span class="line">  - &quot;namespaces&quot;</span><br><span class="line">  - &quot;endpoints&quot;</span><br><span class="line">  verbs:</span><br><span class="line">  - &quot;get&quot;</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: efk</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: efk</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">---</span><br><span class="line"># Elasticsearch deployment itself</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch-logging</span><br><span class="line">  namespace: efk</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: elasticsearch-logging</span><br><span class="line">    version: v7.4.2</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  serviceName: elasticsearch-logging</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: elasticsearch-logging</span><br><span class="line">      version: v7.4.2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: elasticsearch-logging</span><br><span class="line">        version: v7.4.2</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: elasticsearch-logging</span><br><span class="line">      containers:</span><br><span class="line">      - image: quay.io/fluentd_elasticsearch/elasticsearch:v7.4.2 </span><br><span class="line">        name: elasticsearch-logging</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          # need more cpu upon initialization, therefore burstable class</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">            memory: 3Gi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 3Gi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9200</span><br><span class="line">          name: db</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9300</span><br><span class="line">          name: transport</span><br><span class="line">          protocol: TCP</span><br><span class="line">        #livenessProbe:</span><br><span class="line">        #  tcpSocket:</span><br><span class="line">        #    port: transport</span><br><span class="line">        #  initialDelaySeconds: 5</span><br><span class="line">        #  timeoutSeconds: 10</span><br><span class="line">        #readinessProbe:</span><br><span class="line">        #  tcpSocket:</span><br><span class="line">        #    port: transport</span><br><span class="line">        #  initialDelaySeconds: 5</span><br><span class="line">        #  timeoutSeconds: 10</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: elasticsearch-logging</span><br><span class="line">          mountPath: /data</span><br><span class="line">        env:</span><br><span class="line">        - name: &quot;NAMESPACE&quot;</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">      volumes:</span><br><span class="line">      - name: elasticsearch-logging</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: ceph-elasticsearch</span><br><span class="line">        #emptyDir: &#123;&#125;</span><br><span class="line">      # Elasticsearch requires vm.max_map_count to be at least 262144.</span><br><span class="line">      # If your OS already sets up this number to a higher value, feel free</span><br><span class="line">      # to remove this init container.</span><br><span class="line">      initContainers:</span><br><span class="line">      - image: alpine:3.6</span><br><span class="line">        command: [&quot;/sbin/sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]</span><br><span class="line">        name: elasticsearch-logging-init</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph-elasticsearch</span><br><span class="line">  namespace: efk</span><br><span class="line">  labels:</span><br><span class="line">    app: elasticsearch</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: ceph-efk</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f elasticsearch.yaml</span><br></pre></td></tr></table></figure>

<h2 id="创建Kibana"><a href="#创建Kibana" class="headerlink" title="创建Kibana"></a>创建Kibana</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kibana.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana-logging</span><br><span class="line">  namespace: efk</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kibana-logging</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/name: &quot;Kibana&quot;</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 5601</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: ui</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kibana-logging</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana-logging</span><br><span class="line">  namespace: efk</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kibana-logging</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kibana-logging</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kibana-logging</span><br><span class="line">      annotations:</span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: &#x27;docker/default&#x27;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana-logging</span><br><span class="line">        image: docker.elastic.co/kibana/kibana-oss:7.2.0</span><br><span class="line">        resources:</span><br><span class="line">          # need more cpu upon initialization, therefore burstable class</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        env:</span><br><span class="line">          - name: ELASTICSEARCH_HOSTS</span><br><span class="line">            value: http://elasticsearch-logging:9200</span><br><span class="line">          - name: SERVER_NAME</span><br><span class="line">            value: kibana-logging</span><br><span class="line">          #- name: SERVER_BASEPATH</span><br><span class="line">          #  value: /api/v1/namespaces/efk/services/kibana-logging/proxy</span><br><span class="line">          - name: SERVER_REWRITEBASEPATH</span><br><span class="line">            value: &quot;false&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">          name: ui</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/status</span><br><span class="line">            port: ui</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/status</span><br><span class="line">            port: ui</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f kibana.yaml</span><br></pre></td></tr></table></figure>

<h2 id="创建Fluentd-ConfigMap"><a href="#创建Fluentd-ConfigMap" class="headerlink" title="创建Fluentd ConfigMap"></a>创建Fluentd ConfigMap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluentd-es-config.yaml &lt;&lt; EOF</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es-config-v0.2.0</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">data:</span><br><span class="line">  system.conf: |-</span><br><span class="line">    &lt;system&gt;</span><br><span class="line">      root_dir /tmp/fluentd-buffers/</span><br><span class="line">    &lt;/system&gt;</span><br><span class="line"></span><br><span class="line">  containers.input.conf: |-</span><br><span class="line">    # This configuration file for Fluentd / td-agent is used</span><br><span class="line">    # to watch changes to Docker log files. The kubelet creates symlinks that</span><br><span class="line">    # capture the pod name, namespace, container name &amp; Docker container ID</span><br><span class="line">    # to the docker logs for pods in the /var/log/containers directory on the host.</span><br><span class="line">    # If running this fluentd configuration in a Docker container, the /var/log</span><br><span class="line">    # directory should be mounted in the container.</span><br><span class="line">    #</span><br><span class="line">    # These logs are then submitted to Elasticsearch which assumes the</span><br><span class="line">    # installation of the fluent-plugin-elasticsearch &amp; the</span><br><span class="line">    # fluent-plugin-kubernetes_metadata_filter plugins.</span><br><span class="line">    # See https://github.com/uken/fluent-plugin-elasticsearch &amp;</span><br><span class="line">    # https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter for</span><br><span class="line">    # more information about the plugins.</span><br><span class="line">    #</span><br><span class="line">    # Example</span><br><span class="line">    # =======</span><br><span class="line">    # A line in the Docker log file might look like this JSON:</span><br><span class="line">    #</span><br><span class="line">    # &#123;&quot;log&quot;:&quot;2014/09/25 21:15:03 Got request with path wombat\n&quot;,</span><br><span class="line">    #  &quot;stream&quot;:&quot;stderr&quot;,</span><br><span class="line">    #   &quot;time&quot;:&quot;2014-09-25T21:15:03.499185026Z&quot;&#125;</span><br><span class="line">    #</span><br><span class="line">    # The time_format specification below makes sure we properly</span><br><span class="line">    # parse the time format produced by Docker. This will be</span><br><span class="line">    # submitted to Elasticsearch and should appear like:</span><br><span class="line">    # $ curl &#x27;http://elasticsearch-logging:9200/_search?pretty&#x27;</span><br><span class="line">    # ...</span><br><span class="line">    # &#123;</span><br><span class="line">    #      &quot;_index&quot; : &quot;logstash-2014.09.25&quot;,</span><br><span class="line">    #      &quot;_type&quot; : &quot;fluentd&quot;,</span><br><span class="line">    #      &quot;_id&quot; : &quot;VBrbor2QTuGpsQyTCdfzqA&quot;,</span><br><span class="line">    #      &quot;_score&quot; : 1.0,</span><br><span class="line">    #      &quot;_source&quot;:&#123;&quot;log&quot;:&quot;2014/09/25 22:45:50 Got request with path wombat\n&quot;,</span><br><span class="line">    #                 &quot;stream&quot;:&quot;stderr&quot;,&quot;tag&quot;:&quot;docker.container.all&quot;,</span><br><span class="line">    #                 &quot;@timestamp&quot;:&quot;2014-09-25T22:45:50+00:00&quot;&#125;</span><br><span class="line">    #    &#125;,</span><br><span class="line">    # ...</span><br><span class="line">    #</span><br><span class="line">    # The Kubernetes fluentd plugin is used to write the Kubernetes metadata to the log</span><br><span class="line">    # record &amp; add labels to the log record if properly configured. This enables users</span><br><span class="line">    # to filter &amp; search logs on any metadata.</span><br><span class="line">    # For example a Docker container&#x27;s logs might be in the directory:</span><br><span class="line">    #</span><br><span class="line">    #  /var/lib/docker/containers/997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b</span><br><span class="line">    #</span><br><span class="line">    # and in the file:</span><br><span class="line">    #</span><br><span class="line">    #  997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b-json.log</span><br><span class="line">    #</span><br><span class="line">    # where 997599971ee6... is the Docker ID of the running container.</span><br><span class="line">    # The Kubernetes kubelet makes a symbolic link to this file on the host machine</span><br><span class="line">    # in the /var/log/containers directory which includes the pod name and the Kubernetes</span><br><span class="line">    # container name:</span><br><span class="line">    #</span><br><span class="line">    #    synthetic-logger-0.25lps-pod_default_synth-lgr-997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b.log</span><br><span class="line">    #    -&gt;</span><br><span class="line">    #    /var/lib/docker/containers/997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b/997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b-json.log</span><br><span class="line">    #</span><br><span class="line">    # The /var/log directory on the host is mapped to the /var/log directory in the container</span><br><span class="line">    # running this instance of Fluentd and we end up collecting the file:</span><br><span class="line">    #</span><br><span class="line">    #   /var/log/containers/synthetic-logger-0.25lps-pod_default_synth-lgr-997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b.log</span><br><span class="line">    #</span><br><span class="line">    # This results in the tag:</span><br><span class="line">    #</span><br><span class="line">    #  var.log.containers.synthetic-logger-0.25lps-pod_default_synth-lgr-997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b.log</span><br><span class="line">    #</span><br><span class="line">    # The Kubernetes fluentd plugin is used to extract the namespace, pod name &amp; container name</span><br><span class="line">    # which are added to the log message as a kubernetes field object &amp; the Docker container ID</span><br><span class="line">    # is also added under the docker field object.</span><br><span class="line">    # The final tag is:</span><br><span class="line">    #</span><br><span class="line">    #   kubernetes.var.log.containers.synthetic-logger-0.25lps-pod_default_synth-lgr-997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b.log</span><br><span class="line">    #</span><br><span class="line">    # And the final log record look like:</span><br><span class="line">    #</span><br><span class="line">    # &#123;</span><br><span class="line">    #   &quot;log&quot;:&quot;2014/09/25 21:15:03 Got request with path wombat\n&quot;,</span><br><span class="line">    #   &quot;stream&quot;:&quot;stderr&quot;,</span><br><span class="line">    #   &quot;time&quot;:&quot;2014-09-25T21:15:03.499185026Z&quot;,</span><br><span class="line">    #   &quot;kubernetes&quot;: &#123;</span><br><span class="line">    #     &quot;namespace&quot;: &quot;default&quot;,</span><br><span class="line">    #     &quot;pod_name&quot;: &quot;synthetic-logger-0.25lps-pod&quot;,</span><br><span class="line">    #     &quot;container_name&quot;: &quot;synth-lgr&quot;</span><br><span class="line">    #   &#125;,</span><br><span class="line">    #   &quot;docker&quot;: &#123;</span><br><span class="line">    #     &quot;container_id&quot;: &quot;997599971ee6366d4a5920d25b79286ad45ff37a74494f262e3bc98d909d0a7b&quot;</span><br><span class="line">    #   &#125;</span><br><span class="line">    # &#125;</span><br><span class="line">    #</span><br><span class="line">    # This makes it easier for users to search for logs by pod name or by</span><br><span class="line">    # the name of the Kubernetes container regardless of how many times the</span><br><span class="line">    # Kubernetes pod has been restarted (resulting in a several Docker container IDs).</span><br><span class="line"></span><br><span class="line">    # Json Log Example:</span><br><span class="line">    # &#123;&quot;log&quot;:&quot;[info:2016-02-16T16:04:05.930-08:00] Some log text here\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,&quot;time&quot;:&quot;2016-02-17T00:04:05.931087621Z&quot;&#125;</span><br><span class="line">    # CRI Log Example:</span><br><span class="line">    # 2016-02-17T00:04:05.931087621Z stdout F [info:2016-02-16T16:04:05.930-08:00] Some log text here</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id fluentd-containers.log</span><br><span class="line">      @type tail</span><br><span class="line">      path /var/log/containers/*.log</span><br><span class="line">      pos_file /var/log/es-containers.log.pos</span><br><span class="line">      tag raw.kubernetes.*</span><br><span class="line">      read_from_head true</span><br><span class="line">      &lt;parse&gt;</span><br><span class="line">        @type multi_format</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format json</span><br><span class="line">          time_key time</span><br><span class="line">          time_format %Y-%m-%dT%H:%M:%S.%NZ</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/</span><br><span class="line">          time_format %Y-%m-%dT%H:%M:%S.%N%:z</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">      &lt;/parse&gt;</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Detect exceptions in the log output and forward them as one log entry.</span><br><span class="line">    &lt;match raw.kubernetes.**&gt;</span><br><span class="line">      @id raw.kubernetes</span><br><span class="line">      @type detect_exceptions</span><br><span class="line">      remove_tag_prefix raw</span><br><span class="line">      message log</span><br><span class="line">      stream stream</span><br><span class="line">      multiline_flush_interval 5</span><br><span class="line">      max_bytes 500000</span><br><span class="line">      max_lines 1000</span><br><span class="line">    &lt;/match&gt;</span><br><span class="line"></span><br><span class="line">    # Concatenate multi-line logs</span><br><span class="line">    &lt;filter **&gt;</span><br><span class="line">      @id filter_concat</span><br><span class="line">      @type concat</span><br><span class="line">      key message</span><br><span class="line">      multiline_end_regexp /\n$/</span><br><span class="line">      separator &quot;&quot;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    # Enriches records with Kubernetes metadata</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @id filter_kubernetes_metadata</span><br><span class="line">      @type kubernetes_metadata</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    # Fixes json fields in Elasticsearch</span><br><span class="line">    &lt;filter kubernetes.**&gt;</span><br><span class="line">      @id filter_parser</span><br><span class="line">      @type parser</span><br><span class="line">      key_name log</span><br><span class="line">      reserve_data true</span><br><span class="line">      remove_key_name_field true</span><br><span class="line">      &lt;parse&gt;</span><br><span class="line">        @type multi_format</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format json</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">        &lt;pattern&gt;</span><br><span class="line">          format none</span><br><span class="line">        &lt;/pattern&gt;</span><br><span class="line">      &lt;/parse&gt;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">  system.input.conf: |-</span><br><span class="line">    # Example:</span><br><span class="line">    # 2015-12-21 23:17:22,066 [salt.state       ][INFO    ] Completed state [net.ipv4.ip_forward] at time 23:17:22.066081</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id minion</span><br><span class="line">      @type tail</span><br><span class="line">      format /^(?&lt;time&gt;[^ ]* [^ ,]*)[^\[]*\[[^\]]*\]\[(?&lt;severity&gt;[^ \]]*) *\] (?&lt;message&gt;.*)$/</span><br><span class="line">      time_format %Y-%m-%d %H:%M:%S</span><br><span class="line">      path /var/log/salt/minion</span><br><span class="line">      pos_file /var/log/salt.pos</span><br><span class="line">      tag salt</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # Dec 21 23:17:22 gke-foo-1-1-4b5cbd14-node-4eoj startupscript: Finished running startup script /var/run/google.startup.script</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id startupscript.log</span><br><span class="line">      @type tail</span><br><span class="line">      format syslog</span><br><span class="line">      path /var/log/startupscript.log</span><br><span class="line">      pos_file /var/log/es-startupscript.log.pos</span><br><span class="line">      tag startupscript</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Examples:</span><br><span class="line">    # time=&quot;2016-02-04T06:51:03.053580605Z&quot; level=info msg=&quot;GET /containers/json&quot;</span><br><span class="line">    # time=&quot;2016-02-04T07:53:57.505612354Z&quot; level=error msg=&quot;HTTP Error&quot; err=&quot;No such image: -f&quot; statusCode=404</span><br><span class="line">    # TODO(random-liu): Remove this after cri container runtime rolls out.</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id docker.log</span><br><span class="line">      @type tail</span><br><span class="line">      format /^time=&quot;(?&lt;time&gt;[^&quot;]*)&quot; level=(?&lt;severity&gt;[^ ]*) msg=&quot;(?&lt;message&gt;[^&quot;]*)&quot;( err=&quot;(?&lt;error&gt;[^&quot;]*)&quot;)?( statusCode=($&lt;status_code&gt;\d+))?/</span><br><span class="line">      path /var/log/docker.log</span><br><span class="line">      pos_file /var/log/es-docker.log.pos</span><br><span class="line">      tag docker</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # 2016/02/04 06:52:38 filePurge: successfully removed file /var/etcd/data/member/wal/00000000000006d0-00000000010a23d1.wal</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id etcd.log</span><br><span class="line">      @type tail</span><br><span class="line">      # Not parsing this, because it doesn&#x27;t have anything particularly useful to</span><br><span class="line">      # parse out of it (like severities).</span><br><span class="line">      format none</span><br><span class="line">      path /var/log/etcd.log</span><br><span class="line">      pos_file /var/log/es-etcd.log.pos</span><br><span class="line">      tag etcd</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Multi-line parsing is required for all the kube logs because very large log</span><br><span class="line">    # statements, such as those that include entire object bodies, get split into</span><br><span class="line">    # multiple lines by glog.</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # I0204 07:32:30.020537    3368 server.go:1048] POST /stats/container/: (13.972191ms) 200 [[Go-http-client/1.1] 10.244.1.3:40537]</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id kubelet.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/kubelet.log</span><br><span class="line">      pos_file /var/log/es-kubelet.log.pos</span><br><span class="line">      tag kubelet</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # I1118 21:26:53.975789       6 proxier.go:1096] Port &quot;nodePort for kube-system/default-http-backend:http&quot; (:31429/tcp) was open before and is still needed</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id kube-proxy.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/kube-proxy.log</span><br><span class="line">      pos_file /var/log/es-kube-proxy.log.pos</span><br><span class="line">      tag kube-proxy</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # I0204 07:00:19.604280       5 handlers.go:131] GET /api/v1/nodes: (1.624207ms) 200 [[kube-controller-manager/v1.1.3 (linux/amd64) kubernetes/6a81b50] 127.0.0.1:38266]</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id kube-apiserver.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/kube-apiserver.log</span><br><span class="line">      pos_file /var/log/es-kube-apiserver.log.pos</span><br><span class="line">      tag kube-apiserver</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # I0204 06:55:31.872680       5 servicecontroller.go:277] LB already exists and doesn&#x27;t need update for service kube-system/kube-ui</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id kube-controller-manager.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/kube-controller-manager.log</span><br><span class="line">      pos_file /var/log/es-kube-controller-manager.log.pos</span><br><span class="line">      tag kube-controller-manager</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # W0204 06:49:18.239674       7 reflector.go:245] pkg/scheduler/factory/factory.go:193: watch of *api.Service ended with: 401: The event in requested index is outdated and cleared (the requested history has been cleared [2578313/2577886]) [2579312]</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id kube-scheduler.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/kube-scheduler.log</span><br><span class="line">      pos_file /var/log/es-kube-scheduler.log.pos</span><br><span class="line">      tag kube-scheduler</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # I0603 15:31:05.793605       6 cluster_manager.go:230] Reading config from path /etc/gce.conf</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id glbc.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/glbc.log</span><br><span class="line">      pos_file /var/log/es-glbc.log.pos</span><br><span class="line">      tag glbc</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Example:</span><br><span class="line">    # I0603 15:31:05.793605       6 cluster_manager.go:230] Reading config from path /etc/gce.conf</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id cluster-autoscaler.log</span><br><span class="line">      @type tail</span><br><span class="line">      format multiline</span><br><span class="line">      multiline_flush_interval 5s</span><br><span class="line">      format_firstline /^\w\d&#123;4&#125;/</span><br><span class="line">      format1 /^(?&lt;severity&gt;\w)(?&lt;time&gt;\d&#123;4&#125; [^\s]*)\s+(?&lt;pid&gt;\d+)\s+(?&lt;source&gt;[^ \]]+)\] (?&lt;message&gt;.*)/</span><br><span class="line">      time_format %m%d %H:%M:%S.%N</span><br><span class="line">      path /var/log/cluster-autoscaler.log</span><br><span class="line">      pos_file /var/log/es-cluster-autoscaler.log.pos</span><br><span class="line">      tag cluster-autoscaler</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # Logs from systemd-journal for interesting services.</span><br><span class="line">    # TODO(random-liu): Remove this after cri container runtime rolls out.</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id journald-docker</span><br><span class="line">      @type systemd</span><br><span class="line">      matches [&#123; &quot;_SYSTEMD_UNIT&quot;: &quot;docker.service&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">        path /var/log/journald-docker.pos</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag docker</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id journald-container-runtime</span><br><span class="line">      @type systemd</span><br><span class="line">      matches [&#123; &quot;_SYSTEMD_UNIT&quot;: &quot;&#123;&#123; fluentd_container_runtime_service &#125;&#125;.service&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">        path /var/log/journald-container-runtime.pos</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag container-runtime</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id journald-kubelet</span><br><span class="line">      @type systemd</span><br><span class="line">      matches [&#123; &quot;_SYSTEMD_UNIT&quot;: &quot;kubelet.service&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">        path /var/log/journald-kubelet.pos</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag kubelet</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id journald-node-problem-detector</span><br><span class="line">      @type systemd</span><br><span class="line">      matches [&#123; &quot;_SYSTEMD_UNIT&quot;: &quot;node-problem-detector.service&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">        path /var/log/journald-node-problem-detector.pos</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag node-problem-detector</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id kernel</span><br><span class="line">      @type systemd</span><br><span class="line">      matches [&#123; &quot;_TRANSPORT&quot;: &quot;kernel&quot; &#125;]</span><br><span class="line">      &lt;storage&gt;</span><br><span class="line">        @type local</span><br><span class="line">        persistent true</span><br><span class="line">        path /var/log/kernel.pos</span><br><span class="line">      &lt;/storage&gt;</span><br><span class="line">      &lt;entry&gt;</span><br><span class="line">        fields_strip_underscores true</span><br><span class="line">        fields_lowercase true</span><br><span class="line">      &lt;/entry&gt;</span><br><span class="line">      read_from_head true</span><br><span class="line">      tag kernel</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">  forward.input.conf: |-</span><br><span class="line">    # Takes the messages sent over TCP</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id forward</span><br><span class="line">      @type forward</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">  monitoring.conf: |-</span><br><span class="line">    # Prometheus Exporter Plugin</span><br><span class="line">    # input plugin that exports metrics</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id prometheus</span><br><span class="line">      @type prometheus</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id monitor_agent</span><br><span class="line">      @type monitor_agent</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # input plugin that collects metrics from MonitorAgent</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id prometheus_monitor</span><br><span class="line">      @type prometheus_monitor</span><br><span class="line">      &lt;labels&gt;</span><br><span class="line">        host $&#123;hostname&#125;</span><br><span class="line">      &lt;/labels&gt;</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # input plugin that collects metrics for output plugin</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id prometheus_output_monitor</span><br><span class="line">      @type prometheus_output_monitor</span><br><span class="line">      &lt;labels&gt;</span><br><span class="line">        host $&#123;hostname&#125;</span><br><span class="line">      &lt;/labels&gt;</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">    # input plugin that collects metrics for in_tail plugin</span><br><span class="line">    &lt;source&gt;</span><br><span class="line">      @id prometheus_tail_monitor</span><br><span class="line">      @type prometheus_tail_monitor</span><br><span class="line">      &lt;labels&gt;</span><br><span class="line">        host $&#123;hostname&#125;</span><br><span class="line">      &lt;/labels&gt;</span><br><span class="line">    &lt;/source&gt;</span><br><span class="line"></span><br><span class="line">  output.conf: |-</span><br><span class="line">    &lt;match **&gt;</span><br><span class="line">      @id elasticsearch</span><br><span class="line">      @type elasticsearch</span><br><span class="line">      @log_level info</span><br><span class="line">      type_name _doc</span><br><span class="line">      include_tag_key true</span><br><span class="line">      host elasticsearch-logging</span><br><span class="line">      port 9200</span><br><span class="line">      logstash_format true</span><br><span class="line">      &lt;buffer&gt;</span><br><span class="line">        @type file</span><br><span class="line">        path /var/log/fluentd-buffers/kubernetes.system.buffer</span><br><span class="line">        flush_mode interval</span><br><span class="line">        retry_type exponential_backoff</span><br><span class="line">        flush_thread_count 2</span><br><span class="line">        flush_interval 5s</span><br><span class="line">        retry_forever</span><br><span class="line">        retry_max_interval 30</span><br><span class="line">        chunk_limit_size 2M</span><br><span class="line">        total_limit_size 500M</span><br><span class="line">        overflow_action block</span><br><span class="line">      &lt;/buffer&gt;</span><br><span class="line">    &lt;/match&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl appply -f fluentd-es-config.yaml</span><br></pre></td></tr></table></figure>


<h2 id="创建Fluentd"><a href="#创建Fluentd" class="headerlink" title="创建Fluentd"></a>创建Fluentd</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; fluentd-es.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - &quot;namespaces&quot;</span><br><span class="line">  - &quot;pods&quot;</span><br><span class="line">  verbs:</span><br><span class="line">  - &quot;get&quot;</span><br><span class="line">  - &quot;watch&quot;</span><br><span class="line">  - &quot;list&quot;</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: fluentd-es</span><br><span class="line">  apiGroup: &quot;&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-es-v3.0.0</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-es</span><br><span class="line">    version: v3.0.0</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: fluentd-es</span><br><span class="line">      version: v3.0.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: fluentd-es</span><br><span class="line">        version: v3.0.0</span><br><span class="line">      # This annotation ensures that fluentd does not get evicted if the node</span><br><span class="line">      # supports critical pod annotation based priority scheme.</span><br><span class="line">      # Note that this does not guarantee admission on the nodes (#40573).</span><br><span class="line">      annotations:</span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: &#x27;docker/default&#x27;</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      serviceAccountName: fluentd-es</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-es</span><br><span class="line">        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.0</span><br><span class="line">        env:</span><br><span class="line">        - name: FLUENTD_ARGS</span><br><span class="line">          value: --no-supervisor -q</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: /var/log</span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: /var/lib/docker/containers</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/fluent/config.d</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 24231</span><br><span class="line">          name: prometheus</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: prometheus</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: prometheus</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 10</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/log</span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/lib/docker/containers</span><br><span class="line">      - name: config-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: fluentd-es-config-v0.2.0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f fluentd-es.yaml</span><br></pre></td></tr></table></figure>


<h2 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h2><p><a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator">https://github.com/coreos/prometheus-operator</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus">https://github.com/prometheus/prometheus</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-incubator/external-storage">https://github.com/kubernetes-incubator/external-storage</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">https://kubernetes.io/docs/concepts/storage/persistent-volumes/</a></p>
<p><a target="_blank" rel="noopener" href="https://quay.io/repository/external_storage/rbd-provisioner?tab=tags">https://quay.io/repository/external_storage/rbd-provisioner?tab=tags</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/ceph/" rel="tag"># ceph</a>
              <a href="/tags/kubernets/" rel="tag"># kubernets</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/407ebcc2.html" rel="prev" title="故障问题收集">
      <i class="fa fa-chevron-left"></i> 故障问题收集
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/58d7ce25.html" rel="next" title="Ceph RBD介绍与使用">
      Ceph RBD介绍与使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">前期准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83"><span class="nav-number">1.1.</span> <span class="nav-text">环境</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ceph"><span class="nav-number">2.</span> <span class="nav-text">Ceph</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ceph-%E5%88%9B%E5%BB%BA%E8%B4%A6%E5%8F%B7"><span class="nav-number">3.</span> <span class="nav-text">Ceph 创建账号</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#K8S-%E4%BD%BF%E7%94%A8-Ceph-RBD%E5%AD%98%E5%82%A8"><span class="nav-number">4.</span> <span class="nav-text">K8S 使用 Ceph RBD存储</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-namespace"><span class="nav-number">4.1.</span> <span class="nav-text">创建 namespace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E5%AD%98%E5%82%A8%E7%B1%BB%E6%8F%90%E4%BE%9Bsecret"><span class="nav-number">4.2.</span> <span class="nav-text">为存储类提供secret</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%8A%A8%E6%80%81RBD-StorageClass"><span class="nav-number">4.3.</span> <span class="nav-text">创建动态RBD StorageClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAcontroller-manager%E6%8F%90%E4%BE%9Brbd%E5%91%BD%E4%BB%A4"><span class="nav-number">4.4.</span> <span class="nav-text">为controller-manager提供rbd命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAkubelet%E6%8F%90%E4%BE%9Brbd%E5%91%BD%E4%BB%A4"><span class="nav-number">4.5.</span> <span class="nav-text">为kubelet提供rbd命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAElasticsearch"><span class="nav-number">4.6.</span> <span class="nav-text">创建Elasticsearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAKibana"><span class="nav-number">4.7.</span> <span class="nav-text">创建Kibana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAFluentd-ConfigMap"><span class="nav-number">4.8.</span> <span class="nav-text">创建Fluentd ConfigMap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAFluentd"><span class="nav-number">4.9.</span> <span class="nav-text">创建Fluentd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3"><span class="nav-number">4.10.</span> <span class="nav-text">相关文档</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hyman</p>
  <div class="site-description" itemprop="description">一些简单的记录</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">215</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">142</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hyman0603" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hyman0603" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hyman</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
