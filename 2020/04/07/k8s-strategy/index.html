<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.ywthings.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="在Kubernetes中有几种不同的方式发布应用，所以为了让应用在升级期间依然平稳提供服务，选择一个正确的发布策略就非常重要了。 选择正确的部署策略是要依赖于我们的业务需求的，下面我们列出了一些可能会使用到的策略：  重建(recreate)：停止旧版本部署新版本  滚动更新(rolling-update)：一个接一个地以滚动更新方式发布新版本  蓝绿(blue&#x2F;green)：新版本与旧">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s的几种部署策略">
<meta property="og:url" content="https://www.ywthings.com/2020/04/07/k8s-strategy/index.html">
<meta property="og:site_name" content="hyman-海曼工具">
<meta property="og:description" content="在Kubernetes中有几种不同的方式发布应用，所以为了让应用在升级期间依然平稳提供服务，选择一个正确的发布策略就非常重要了。 选择正确的部署策略是要依赖于我们的业务需求的，下面我们列出了一些可能会使用到的策略：  重建(recreate)：停止旧版本部署新版本  滚动更新(rolling-update)：一个接一个地以滚动更新方式发布新版本  蓝绿(blue&#x2F;green)：新版本与旧">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.ywthings.com/images/RCXtdC.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/30iUcb.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/OIhAqJ.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/mEQW8i.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/FxTxRP.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/RvcM4f.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/OclNv8.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/b4qVNZ.jpg">
<meta property="og:image" content="https://www.ywthings.com/images/2lK8wZ.jpg">
<meta property="article:published_time" content="2020-04-07T04:19:44.000Z">
<meta property="article:modified_time" content="2020-05-17T23:58:42.000Z">
<meta property="article:author" content="hyman">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kubernets">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.ywthings.com/images/RCXtdC.jpg">

<link rel="canonical" href="https://www.ywthings.com/2020/04/07/k8s-strategy/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>k8s的几种部署策略 | hyman-海曼工具</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hyman-海曼工具</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一些简单的记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.ywthings.com/2020/04/07/k8s-strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hyman">
      <meta itemprop="description" content="一些简单的记录">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hyman-海曼工具">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s的几种部署策略
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-07 12:19:44" itemprop="dateCreated datePublished" datetime="2020-04-07T12:19:44+08:00">2020-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-18 07:58:42" itemprop="dateModified" datetime="2020-05-18T07:58:42+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在Kubernetes中有几种不同的方式发布应用，所以为了让应用在升级期间依然平稳提供服务，选择一个正确的发布策略就非常重要了。</p>
<p>选择正确的部署策略是要依赖于我们的业务需求的，下面我们列出了一些可能会使用到的策略：</p>
<ul>
<li><p>重建(recreate)：停止旧版本部署新版本</p>
</li>
<li><p>滚动更新(rolling-update)：一个接一个地以滚动更新方式发布新版本</p>
</li>
<li><p>蓝绿(blue&#x2F;green)：新版本与旧版本一起存在，然后切换流量</p>
</li>
<li><p>金丝雀(canary)：将新版本面向一部分用户发布，然后继续全量发布</p>
</li>
<li><p>A&#x2F;B测(a&#x2F;b testing)：以精确的方式（HTTP 头、cookie、权重等）向部分用户发布新版本。A&#x2F;B测实际上是一种基于数据统计做出业务决策的技术。在 Kubernetes 中并不原生支持，需要额外的一些高级组件来完成改设置（比如Istio、Linkerd、Traefik、或者自定义 Nginx&#x2F;Haproxy 等）。</p>
<span id="more"></span>
<p>你可以在Kubernetes集群上来对上面的这些策略进行测试，下面的仓库中有需要使用到的资源清单：<a target="_blank" rel="noopener" href="https://github.com/ContainerSolutions/k8s-deployment-strategies">https://github.com/ContainerSolutions/k8s-deployment-strategies</a></p>
</li>
</ul>
<p>接下来我们来介绍下每种策略，看看在什么场景下面适合哪种策略。</p>
<h1 id="重建-Recreate-最好在开发环境"><a href="#重建-Recreate-最好在开发环境" class="headerlink" title="重建(Recreate) - 最好在开发环境"></a>重建(Recreate) - 最好在开发环境</h1><p>策略定义为Recreate的Deployment，会终止所有正在运行的实例，然后用较新的版本来重新创建它们。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br></pre></td></tr></table></figure>

<img src="/images/RCXtdC.jpg" width="100%" height="100%">

<p>重新创建策略是一个虚拟部署，包括关闭版本A，然后在关闭版本A后部署版本B. 此技术意味着服务的停机时间取决于应用程序的关闭和启动持续时间。</p>
<p>我们这里创建两个相关的资源清单文件，app-v1.yaml：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: http</span><br><span class="line">  selector:</span><br><span class="line">    app: my-app</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v1.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v1.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>app-v2.yaml 文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v2.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v2.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>上面两个资源清单文件中的 Deployment 定义几乎是一直的，唯一不同的是定义的环境变量VERSION值不同，接下来按照下面的步骤来验证Recreate策略：</p>
<ol>
<li>版本1提供服务</li>
<li>删除版本1</li>
<li>部署版本2</li>
<li>等待所有副本准备就绪</li>
</ol>
<p>首先部署第一个应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v1.yaml</span><br><span class="line">service &quot;my-app&quot; created</span><br><span class="line">deployment.apps &quot;my-app&quot; created</span><br></pre></td></tr></table></figure>

<p>测试版本1是否部署成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l app=my-app</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">my-app-7b4874cd75-m5kct   1/1       Running   0          19m</span><br><span class="line">my-app-7b4874cd75-pc444   1/1       Running   0          19m</span><br><span class="line">my-app-7b4874cd75-tlctl   1/1       Running   0          19m</span><br><span class="line">$ kubectl get svc my-app</span><br><span class="line">NAME      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">my-app    NodePort   10.108.238.76   &lt;none&gt;        80:32532/TCP   5m</span><br><span class="line">$ curl http://127.0.0.1:32532</span><br><span class="line">Host: my-app-7b4874cd75-pc444, Version: v1.0.0</span><br></pre></td></tr></table></figure>

<p>可以看到版本1的应用正常运行了。为了查看部署的运行情况，打开一个新终端并运行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ watch kubectl get po -l app=my-app</span><br></pre></td></tr></table></figure>

<p>然后部署版本2的应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v2.yaml</span><br></pre></td></tr></table></figure>

<p>这个时候可以观察上面新开的终端中的 Pod 列表的变化，可以看到之前的3个 Pod 都会先处于Terminating状态，并且3个 Pod 都被删除后才开始创建新的 Pod。</p>
<p>然后测试第二个版本应用的部署进度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ while sleep 0.1; do curl http://127.0.0.1:32532; done</span><br><span class="line">curl: (7) Failed connect to 127.0.0.1:32532; Connection refused</span><br><span class="line">curl: (7) Failed connect to 127.0.0.1:32532; Connection refused</span><br><span class="line">......</span><br><span class="line">Host: my-app-f885c8d45-sp44p, Version: v2.0.0</span><br><span class="line">Host: my-app-f885c8d45-t8g7g, Version: v2.0.0</span><br><span class="line">Host: my-app-f885c8d45-sp44p, Version: v2.0.0</span><br></pre></td></tr></table></figure>

<p>可以看到最开始的阶段服务都是处于不可访问的状态，然后到第二个版本的应用部署成功后才正常访问，可以看到现在访问的数据是版本2了。</p>
<p>最后，可以执行下面的命令来清空上面的资源对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete all -l app=my-app</span><br></pre></td></tr></table></figure>

<p>结论:</p>
<ul>
<li>应用状态全部更新</li>
<li>停机时间取决于应用程序的关闭和启动消耗的时间</li>
</ul>
<h1 id="滚动更新-rolling-update"><a href="#滚动更新-rolling-update" class="headerlink" title="滚动更新(rolling-update)"></a>滚动更新(rolling-update)</h1><p>滚动更新通过逐个替换实例来逐步部署新版本的应用，直到所有实例都被替换完成为止。它通常遵循以下过程：在负载均衡器后面使用版本 A 的实例池，然后部署版本 B 的一个实例，当服务准备好接收流量时(Readiness Probe 正常)，将该实例添加到实例池中，然后从实例池中删除一个版本 A 的实例并关闭，如下图所示：</p>
<img src="/images/30iUcb.jpg" width="100%" height="100%">

<p>下图是滚动更新过程应用接收流量的示意图：</p>
<img src="/images/OIhAqJ.jpg" width="100%" height="100%">

<p>下面是 Kubernetes 中通过 Deployment 来进行滚动更新的关键参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 2        # 一次可以添加多少个Pod</span><br><span class="line">      maxUnavailable: 1  # 滚动更新期间最大多少个Pod不可用</span><br></pre></td></tr></table></figure>

<p>现在仍然使用上面的 app-v1.yaml 这个资源清单文件，新建一个定义滚动更新的资源清单文件 app-v2-rolling-update.yaml，文件内容如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 10</span><br><span class="line">  # maxUnavailable设置为0可以完全确保在滚动更新期间服务不受影响，还可以使用百分比的值来进行设置。</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 0</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v2.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v2.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          # 初始延迟设置高点可以更好地观察滚动更新过程</span><br><span class="line">          initialDelaySeconds: 15</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>上面的资源清单中我们在环境变量中定义了版本2，然后通过设置strategy.type&#x3D;RollingUpdate来定义该 Deployment 使用滚动更新的策略来更新应用，接下来我们按下面的步骤来验证滚动更新策略：</p>
<ol>
<li>版本1提供服务</li>
<li>部署版本2</li>
<li>等待直到所有副本都被版本2替换完成</li>
</ol>
<p>同样，首先部署版本1应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v1.yaml</span><br><span class="line">service &quot;my-app&quot; created</span><br><span class="line">deployment.apps &quot;my-app&quot; created</span><br></pre></td></tr></table></figure>

<p>测试版本1是否部署成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l app=my-app</span><br><span class="line">NAME                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">my-app-7b4874cd75-h8c4d   1/1       Running   0          47s</span><br><span class="line">my-app-7b4874cd75-p4l8f   1/1       Running   0          47s</span><br><span class="line">my-app-7b4874cd75-qnt7p   1/1       Running   0          47s</span><br><span class="line">$ kubectl get svc my-app</span><br><span class="line">NAME      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">my-app    NodePort   10.109.99.184   &lt;none&gt;        80:30486/TCP   1m</span><br><span class="line">$ curl http://127.0.0.1:30486</span><br><span class="line">Host: my-app-7b4874cd75-qnt7p, Version: v1.0.0</span><br></pre></td></tr></table></figure>

<p>同样，在一个新终端中执行下面命令观察 Pod 变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ watch kubectl get pod -l app=my-app</span><br></pre></td></tr></table></figure>

<p>然后部署滚动更新版本2应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v2-rolling-update.yaml</span><br><span class="line">deployment.apps &quot;my-app&quot; configured</span><br></pre></td></tr></table></figure>

<p>这个时候在上面的 watch 终端中可以看到多了很多 Pod，还在创建当中，并没有一开始就删除之前的 Pod，同样，这个时候执行下面命令，测试应用状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ while sleep 0.1; do curl http://127.0.0.1:30486; done</span><br><span class="line">Host: my-app-7b4874cd75-vrlj7, Version: v1.0.0</span><br><span class="line">......</span><br><span class="line">Host: my-app-7b4874cd75-vrlj7, Version: v1.0.0</span><br><span class="line">Host: my-app-6b5479d97f-2fk24, Version: v2.0.0</span><br><span class="line">Host: my-app-7b4874cd75-p4l8f, Version: v1.0.0</span><br><span class="line">......</span><br><span class="line">Host: my-app-6b5479d97f-s5ctz, Version: v2.0.0</span><br><span class="line">Host: my-app-7b4874cd75-5ldqx, Version: v1.0.0</span><br><span class="line">......</span><br><span class="line">Host: my-app-6b5479d97f-5z6ww, Version: v2.0.0</span><br></pre></td></tr></table></figure>

<p>我们可以看到上面的应用并没有出现不可用的情况，最开始访问到的都是版本1的应用，然后偶尔会出现版本2的应用，直到最后全都变成了版本2的应用，而这个时候看上面 watch 终端中 Pod 已经全部变成10个版本2的应用了，我们可以看到这就是一个逐步替换的过程。</p>
<p>如果在滚动更新过程中发现新版本应用有问题，我们可以通过下面的命令来进行一键回滚：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout undo deploy my-app</span><br><span class="line">deployment.apps &quot;my-app&quot;</span><br></pre></td></tr></table></figure>

<p>如果你想保持两个版本的应用都存在，那么我们也可以执行 pause 命令来暂停更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout pause deploy my-app</span><br><span class="line">deployment.apps &quot;my-app&quot; paused</span><br></pre></td></tr></table></figure>

<p>这个时候我们再去循环访问我们的应用就可以看到偶尔会出现版本1的应用信息了。</p>
<p>如果新版本应用程序没问题了，也可以继续恢复更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout resume deploy my-app</span><br><span class="line">deployment.apps &quot;my-app&quot; resumed</span><br></pre></td></tr></table></figure>

<p>最后，可以执行下面的命令来清空上面的资源对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete all -l app=my-app</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li>版本在实例之间缓慢替换</li>
<li>rollout&#x2F;rollback 可能需要一定时间</li>
<li>无法控制流量</li>
</ul>
<h1 id="蓝-绿-blue-green-最好用来验证-API-版本问题"><a href="#蓝-绿-blue-green-最好用来验证-API-版本问题" class="headerlink" title="蓝&#x2F;绿(blue&#x2F;green) - 最好用来验证 API 版本问题"></a>蓝&#x2F;绿(blue&#x2F;green) - 最好用来验证 API 版本问题</h1><p>蓝&#x2F;绿发布是版本2 与版本1 一起发布，然后流量切换到版本2，也称为红&#x2F;黑部署。蓝&#x2F;绿发布与滚动更新不同，版本2(绿) 与版本1(蓝)一起部署，在测试新版本满足要求后，然后更新更新 Kubernetes 中扮演负载均衡器角色的 Service 对象，通过替换 label selector 中的版本标签来将流量发送到新版本，如下图所示：<br><img src="/images/mEQW8i.jpg" width="100%" height="100%"></p>
<p>下面是蓝绿发布策略下应用方法的示例图：<br><img src="/images/FxTxRP.jpg" width="100%" height="100%"></p>
<p>在 Kubernetes 中，我们可以用两种方法来实现蓝绿发布，通过单个 Service 对象或者 Ingress 控制器来实现蓝绿发布，实际操作都是类似的，都是通过 label 标签去控制。</p>
<p>实现蓝绿发布的关键点就在于 Service 对象中 label selector 标签的匹配方法，比如我们重新定义版本1 的资源清单文件 app-v1-single-svc.yaml，文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: http</span><br><span class="line">  # 注意这里我们匹配 app 和 version 标签，当要切换流量的时候，我们更新 version 标签的值，比如：v2.0.0</span><br><span class="line">  selector:</span><br><span class="line">    app: my-app</span><br><span class="line">    version: v1.0.0</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">      version: v1.0.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v1.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v1.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>上面定义的资源对象中，最重要的就是 Service 中 label selector 的定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selector:</span><br><span class="line">  app: my-app</span><br><span class="line">  version: v1.0.0</span><br></pre></td></tr></table></figure>

<p>版本2 的应用定义和以前一样，新建文件 app-v2-single-svc.yaml，文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app-v2</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">      version: v2.0.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v2.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v2.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>然后按照下面的步骤来验证使用单个 Service 对象实现蓝&#x2F;绿部署的策略：</p>
<ol>
<li>版本1 应用提供服务</li>
<li>部署版本2 应用</li>
<li>等到版本2 应用全部部署完成</li>
<li>切换入口流量从版本1 到版本2</li>
<li>关闭版本1 应用</li>
</ol>
<p>首先，部署版本1 应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v1-single-svc.yaml</span><br><span class="line">service &quot;my-app&quot; created</span><br><span class="line">deployment.apps &quot;my-app-v1&quot; created</span><br></pre></td></tr></table></figure>

<p>测试版本1 应用是否部署成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l app=my-app</span><br><span class="line">NAME                         READY     STATUS    RESTARTS   AGE</span><br><span class="line">my-app-v1-7b4874cd75-7xh6s   1/1       Running   0          41s</span><br><span class="line">my-app-v1-7b4874cd75-dmq8f   1/1       Running   0          41s</span><br><span class="line">my-app-v1-7b4874cd75-t64z7   1/1       Running   0          41s</span><br><span class="line">$ kubectl get svc -l app=my-app</span><br><span class="line">NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">my-app    NodePort   10.106.184.144   &lt;none&gt;        80:31539/TCP   50s</span><br><span class="line">$ curl http://127.0.0.1:31539</span><br><span class="line">Host: my-app-v1-7b4874cd75-7xh6s, Version: v1.0.0</span><br></pre></td></tr></table></figure>

<p>同样，新开一个终端，执行如下命令观察 Pod 变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ watch kubectl get pod -l app=my-app</span><br></pre></td></tr></table></figure>

<p>然后部署版本2 应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v2-single-svc.yaml</span><br><span class="line">deployment.apps &quot;my-app-v2&quot; created</span><br></pre></td></tr></table></figure>

<p>然后在上面 watch 终端中可以看到会多3个my-app-v2开头的 Pod，待这些 Pod 部署成功后，我们再去访问当前的应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ while sleep 0.1; do curl http://127.0.0.1:31539; done</span><br><span class="line">Host: my-app-v1-7b4874cd75-dmq8f, Version: v1.0.0</span><br><span class="line">Host: my-app-v1-7b4874cd75-dmq8f, Version: v1.0.0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>我们会发现访问到的都是版本1 的应用，和我们刚刚部署的版本2 没有任何关系，这是因为我们 Service 对象中通过 label selector 匹配的是version&#x3D;v1.0.0这个标签，我们可以通过修改 Service 对象的匹配标签，将流量路由到标签version&#x3D;v2.0.0的 Pod 去：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch service my-app -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;selector&quot;:&#123;&quot;version&quot;:&quot;v2.0.0&quot;&#125;&#125;&#125;&#x27;</span><br><span class="line">service &quot;my-app&quot; patched</span><br></pre></td></tr></table></figure>

<p>然后再去访问应用，可以发现现在都是版本2 的信息了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ while sleep 0.1; do curl http://127.0.0.1:31539; done</span><br><span class="line">Host: my-app-v2-f885c8d45-r5m6z, Version: v2.0.0</span><br><span class="line">Host: my-app-v2-f885c8d45-r5m6z, Version: v2.0.0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>如果你需要回滚到版本1，同样只需要更改 Service 的匹配标签即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch service my-app -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;selector&quot;:&#123;&quot;version&quot;:&quot;v1.0.0&quot;&#125;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>如果新版本已经完全符合我们的需求了，就可以删除版本1 的应用了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete deploy my-app-v1</span><br></pre></td></tr></table></figure>

<p>最后，同样，执行如下命令清理上述资源对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete all -l app=my-app</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li><p>实时部署&#x2F;回滚</p>
</li>
<li><p>避免版本问题，因为一次更改是整个应用的改变</p>
</li>
<li><p>需要两倍的资源</p>
</li>
<li><p>在发布到生产之前，应该对整个应用进行适当的测试</p>
</li>
</ul>
<h1 id="金丝雀-Canary-让部分用户参与测试"><a href="#金丝雀-Canary-让部分用户参与测试" class="headerlink" title="金丝雀(Canary) - 让部分用户参与测试"></a>金丝雀(Canary) - 让部分用户参与测试</h1><p>金丝雀部署是让部分用户访问到新版本应用，在 Kubernetes 中，可以使用两个具有相同 Pod 标签的 Deployment 来实现金丝雀部署。新版本的副本和旧版本的一起发布。在一段时间后如果没有检测到错误，则可以扩展新版本的副本数量并删除旧版本的应用。</p>
<p>如果需要按照具体的百分比来进行金丝雀发布，需要尽可能的启动多的 Pod 副本，这样计算流量百分比的时候才方便，比如，如果你想将 1% 的流量发送到版本 B，那么我们就需要有一个运行版本 B 的 Pod 和 99 个运行版本 A 的 Pod，当然如果你对具体的控制策略不在意的话也就无所谓了，如果你需要更精确的控制策略，建议使用服务网格（如 Istio），它们可以更好地控制流量。</p>
<img src="/images/RvcM4f.jpg" width="100%" height="100%">

<p>在下面的例子中，我们使用 Kubernetes 原生特性来实现一个穷人版的金丝雀发布，如果你想要对流量进行更加细粒度的控制，请使用豪华版本的 Istio。下面是金丝雀发布的应用请求示意图：</p>
<img src="/images/OclNv8.jpg" width="100%" height="100%">

<p>接下来我们按照下面的步骤来验证金丝雀策略：</p>
<ol>
<li>10个副本的版本1 应用提供服务</li>
<li>版本2 应用部署1个副本（意味着小于10%的流量）</li>
<li>等待足够的时间来确认版本2 应用足够稳定没有任何错误信息</li>
<li>将版本2 应用扩容到10个副本</li>
<li>等待所有实例完成</li>
<li>关闭版本1 应用</li>
</ol>
<p>首先，创建版本1 的应用资源清单，app-v1-canary.yaml，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: http</span><br><span class="line">  selector:</span><br><span class="line">    app: my-app</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">      version: v1.0.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v1.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v1.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>其中核心的部分也是 Service 对象中的 label selector 标签，不在具有版本相关的标签了，然后定义版本2 的资源清单文件，app-v2-canary.yaml，文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app-v2</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br><span class="line">      version: v2.0.0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">        version: v2.0.0</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9101&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-app</span><br><span class="line">        image: containersol/k8s-deployment-strategies</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        - name: probe</span><br><span class="line">          containerPort: 8086</span><br><span class="line">        env:</span><br><span class="line">        - name: VERSION</span><br><span class="line">          value: v2.0.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /live</span><br><span class="line">            port: probe</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /ready</span><br><span class="line">            port: probe</span><br><span class="line">          periodSeconds: 5</span><br></pre></td></tr></table></figure>

<p>版本1 和版本2 的 Pod 都具有一个共同的标签app&#x3D;my-app，所以对应的 Service 会匹配两个版本的 Pod。</p>
<p>首先，部署版本1 应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v1-canary.yaml</span><br><span class="line">service &quot;my-app&quot; created</span><br><span class="line">deployment.apps &quot;my-app-v1&quot; created</span><br></pre></td></tr></table></figure>

<p>然后测试版本1 应用是否正确部署了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -l app=my-app</span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">my-app        NodePort    10.105.133.213   &lt;none&gt;        80:30760/TCP   47s</span><br><span class="line">$ curl http://127.0.0.1:30760</span><br><span class="line">Host: my-app-v1-7b4874cd75-tsh2s, Version: v1.0.0</span><br></pre></td></tr></table></figure>

<p>同样，新开一个终端，查看 Pod 的变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ watch kubectl get pod</span><br></pre></td></tr></table></figure>
<p>然后部署版本2 应用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f app-v2-canary.yaml</span><br><span class="line">deployment.apps &quot;my-app-v2&quot; created</span><br></pre></td></tr></table></figure>

<p>然后在 watch 终端页面可以看到多了一个 Pod，现在一共 11 个 Pod，其中只有1 个 Pod 运行新版本应用，然后同样可以循环访问该应用，查看是否会有版本2 的应用信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ while sleep 0.1; do curl http://127.0.0.1:30760; done</span><br><span class="line">Host: my-app-v1-7b4874cd75-bhxbp, Version: v1.0.0</span><br><span class="line">Host: my-app-v1-7b4874cd75-wmcqc, Version: v1.0.0</span><br><span class="line">Host: my-app-v1-7b4874cd75-tsh2s, Version: v1.0.0</span><br><span class="line">Host: my-app-v1-7b4874cd75-ml58j, Version: v1.0.0</span><br><span class="line">Host: my-app-v1-7b4874cd75-spsdv, Version: v1.0.0</span><br><span class="line">Host: my-app-v2-f885c8d45-mc2fx, Version: v2.0.0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>正常情况下可以看到大部分都是返回的版本1 的应用信息，偶尔会出现版本2 的应用信息，这就证明我们的金丝雀发布成功了，待确认了版本2 的这个应用没有任何问题后，可以将版本2 应用扩容到10 个副本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale --replicas=10 deploy my-app-v2</span><br><span class="line">deployment.extensions &quot;my-app-v2&quot; scaled</span><br></pre></td></tr></table></figure>

<p>其实这个时候访问应用的话新版本和旧版本的流量分配是1:1了，确认了版本2 正常后，就可以删除版本1 的应用了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete deploy my-app-v1</span><br><span class="line">deployment.extensions &quot;my-app-v1&quot; deleted</span><br></pre></td></tr></table></figure>

<p>最终留下的是 10 个新版本的 Pod 了，到这里我们的整个金丝雀发布就完成了。</p>
<p>同样，最后，执行下面的命令删除上面的资源对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete all -l app=my-app</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<ul>
<li>部分用户获取新版本</li>
<li>方便错误和性能监控</li>
<li>快速回滚</li>
<li>发布较慢</li>
<li>流量精准控制很浪费（99％A &#x2F; 1％B &#x3D; 99 Pod A，1 Pod B）</li>
</ul>
<h1 id="A-B测试-A-B-testing-最适合部分用户的功能测试"><a href="#A-B测试-A-B-testing-最适合部分用户的功能测试" class="headerlink" title="A&#x2F;B测试(A&#x2F;B testing) - 最适合部分用户的功能测试"></a>A&#x2F;B测试(A&#x2F;B testing) - 最适合部分用户的功能测试</h1><p>A&#x2F;B 测试实际上是一种基于统计信息而非部署策略来制定业务决策的技术，与业务结合非常紧密。但是它们也是相关的，也可以使用金丝雀发布来实现。</p>
<p>除了基于权重在版本之间进行流量控制之外，A&#x2F;B 测试还可以基于一些其他参数（比如 Cookie、User Agent、地区等等）来精确定位给定的用户群，该技术广泛用于测试一些功能特性的效果，然后按照效果来进行确定。</p>
<p>要使用这些细粒度的控制，仍然还是建议使用 Istio，可以根据权重或 HTTP 头等来动态请求路由控制流量转发。</p>
<img src="/images/b4qVNZ.jpg" width="100%" height="100%">

<p>下面是使用 Istio 进行规则设置的示例，因为 Istio 还不太稳定，以下示例规则将来可能会更改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">- tags:</span><br><span class="line">  version: v1.0.0</span><br><span class="line">  weight: 90</span><br><span class="line">- tags:</span><br><span class="line">  version: v2.0.0</span><br><span class="line">  weight: 10</span><br></pre></td></tr></table></figure>

<p>关于在 Istio 中具体如何做 A&#x2F;B 测试，我们这里就不再详细介绍了，我们在istio-book文档中有相关的介绍。</p>
<img src="/images/2lK8wZ.jpg" width="100%" height="100%">

<p>结论：</p>
<ul>
<li>几个版本并行运行</li>
<li>完全控制流量分配</li>
<li>特定的一个访问错误难以排查，需要分布式跟踪</li>
<li>Kubernetes 没有直接的支持，需要其他额外的工具</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>发布应用有许多种方法，当发布到开发&#x2F;测试环境的时候，重建或者滚动更新通常是一个不错的选择。在生产环境，滚动更新或者蓝绿发布比较合适，但是新版本的提前测试是非常有必要的。如果你对新版本的应用不是很有信心的话，那应该使用金丝雀发布，将用户的影响降到最低。最后，如果你的公司需要在特定的用户群体中进行新功能的测试，例如，移动端用户请求路由到版本 A，桌面端用户请求路由到版本 B，那么你就看使用A&#x2F;B 测试，通过使用 Kubernetes 服务网关的配置，可以根据某些请求参数来确定用户应路由的服务。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/kubernets/" rel="tag"># kubernets</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/03/etcd/" rel="prev" title="备份etcd">
      <i class="fa fa-chevron-left"></i> 备份etcd
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/07/k8s-get-client-realip/" rel="next" title="k8s获取客户端访问真实 IP">
      k8s获取客户端访问真实 IP <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8D%E5%BB%BA-Recreate-%E6%9C%80%E5%A5%BD%E5%9C%A8%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="nav-number">1.</span> <span class="nav-text">重建(Recreate) - 最好在开发环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0-rolling-update"><span class="nav-number">2.</span> <span class="nav-text">滚动更新(rolling-update)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%93%9D-%E7%BB%BF-blue-green-%E6%9C%80%E5%A5%BD%E7%94%A8%E6%9D%A5%E9%AA%8C%E8%AF%81-API-%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">蓝&#x2F;绿(blue&#x2F;green) - 最好用来验证 API 版本问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%91%E4%B8%9D%E9%9B%80-Canary-%E8%AE%A9%E9%83%A8%E5%88%86%E7%94%A8%E6%88%B7%E5%8F%82%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="nav-number">4.</span> <span class="nav-text">金丝雀(Canary) - 让部分用户参与测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#A-B%E6%B5%8B%E8%AF%95-A-B-testing-%E6%9C%80%E9%80%82%E5%90%88%E9%83%A8%E5%88%86%E7%94%A8%E6%88%B7%E7%9A%84%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">5.</span> <span class="nav-text">A&#x2F;B测试(A&#x2F;B testing) - 最适合部分用户的功能测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hyman</p>
  <div class="site-description" itemprop="description">一些简单的记录</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">237</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">158</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hyman0603" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hyman0603" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2023127571号 </a>
      <img src="/images/beian3.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44132302100239" rel="noopener" target="_blank">粤公网安备44132302100239号 </a>
  </div>

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hyman</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
